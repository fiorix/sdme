.TH SDME 1 "2026-02-23" "sdme" "User Commands"
.SH NAME
sdme \- lightweight systemd\-nspawn containers with overlayfs
.SH SYNOPSIS
.B sdme
[\fB\-v\fR] [\fB\-c\fR \fIpath\fR]
.I command
[\fIargs\fR...]
.SH DESCRIPTION
.B sdme
manages lightweight containers using
.BR systemd\-nspawn (1)
with overlayfs copy\-on\-write storage.
Each container uses an imported root filesystem as its read\-only lower layer,
keeping the base rootfs untouched while all modifications are stored in a
per\-container upper layer.
.PP
Containers are managed as systemd template units
.RB ( sdme@.service )
and controlled via D\-Bus.
Interactive access uses
.BR machinectl (1).
.PP
.B sdme
requires root privileges.
When invoked via
.BR sudo (8),
the invoking user's configuration file is preferred.
.SH OPTIONS
.TP
.BR \-v ", " \-\-verbose
Enable verbose output.
Implies non\-interactive mode at runtime.
.TP
.BR \-c ", " \-\-config " " \fIpath\fR
Path to config file.
Default:
.IR ~/.config/sdme/sdmerc .
.SH COMMANDS
.SS sdme new [\fIname\fR] [\-r \fIfs\fR] [\-t \fIseconds\fR] [\fIlimits\fR] [\fInetwork\fR] [\-\-] [\fIcommand\fR...]
Create, start, and enter a new container.
If
.I name
is omitted, a name is generated automatically.
If
.B \-r
is omitted, the host filesystem is used.
Use
.B \-t
to override the boot timeout (default: 60 seconds or the
.B boot_timeout
config value).
An optional command overrides the default login shell.
.PP
Resource limits can be set with
.BR \-\-memory ,
.BR \-\-cpus ,
and
.BR \-\-cpu\-weight ;
see
.B RESOURCE LIMITS
below.
.PP
Network options can be set with
.BR \-\-private\-network ,
.BR \-\-network\-veth ,
.BR \-\-network\-bridge ,
.BR \-\-network\-zone ,
and
.BR \-\-port ;
see
.B NETWORKING
below.
.PP
If boot fails or is interrupted (Ctrl+C), the just\-created container is
automatically removed.
.SS sdme create [\fIname\fR] [\-r \fIfs\fR] [\fIlimits\fR] [\fInetwork\fR]
Create a new container without starting it.
Sets up the overlayfs directories and state file.
Resource limits can be set with
.BR \-\-memory ,
.BR \-\-cpus ,
and
.BR \-\-cpu\-weight ;
see
.B RESOURCE LIMITS
below.
Network options can be set with
.BR \-\-private\-network ,
.BR \-\-network\-veth ,
.BR \-\-network\-bridge ,
.BR \-\-network\-zone ,
and
.BR \-\-port ;
see
.B NETWORKING
below.
Requires a permissive umask (see
.B NOTES
below).
.SS sdme start \fIname\fR [\-t \fIseconds\fR]
Start a stopped container.
Installs or updates the
.B sdme@.service
template unit if needed, then starts the unit via D\-Bus.
Use
.B \-t
to override the boot timeout (default: 60 seconds or the
.B boot_timeout
config value).
.PP
If boot fails or is interrupted (Ctrl+C), the container is stopped but
preserved on disk for debugging.
.SS sdme set \fIname\fR [\-\-memory \fIsize\fR] [\-\-cpus \fIn\fR] [\-\-cpu\-weight \fIw\fR]
Set resource limits on an existing container, replacing all current limits.
Flags that are not provided are cleared.
See
.B RESOURCE LIMITS
below for details on each flag.
.PP
If the container is running, a note is printed advising a restart for the
changes to take effect.
.SS sdme join \fIname\fR [\-\-] [\fIcommand\fR...]
Enter a running container using
.BR machinectl (1)
shell.
An optional command overrides the default login shell.
.SS sdme exec \fIname\fR \fIcommand\fR [\fIargs\fR...]
Run a one\-off command in a running container using
.BR machinectl (1)
shell.
.SS sdme stop [\-a] \fIname\fR...
Stop one or more running containers via D\-Bus (TerminateMachine)
for a clean shutdown.
Use
.B \-a
to stop all running containers (cannot be combined with names).
.SS sdme rm [\-a] \fIname\fR...
Remove one or more containers.
Running containers are stopped first.
Deletes the state file and all overlayfs directories.
Use
.B \-a
to remove all containers (cannot be combined with names).
.SS sdme ps
List all containers with their status, health, detected OS, and shared directory path.
Health checks detect broken containers (missing directories, missing rootfs).
The OS column shows the distro name from the rootfs os\-release file.
.SS sdme logs \fIname\fR [\fIargs\fR...]
View container logs by executing
.BR journalctl (1)
for the container's service unit.
Extra arguments are passed through to journalctl
(e.g.\&
.BR \-f ,
.BR "\-n 100" ).
.SS sdme fs import \fIname\fR \fIsource\fR [\-f] [\-\-install\-packages \fImode\fR]
Import a root filesystem.
After import, systemd is detected in the rootfs; if missing, distro\-specific
packages can be installed via chroot.
The
.B \-\-install\-packages
flag controls this:
.B auto
(default) prompts interactively,
.B yes
always installs,
.B no
refuses if systemd is absent.
.PP
The source type is auto\-detected:
.RS
.IP \(bu 2
.B URL
.RI ( http:// " or " https:// )
\(em download and extract tarball
.IP \(bu 2
.B Directory
\(em copy the directory tree
.IP \(bu 2
.B QCOW2 image
(detected by magic bytes) \(em mount via
.BR qemu\-nbd (8)
and copy the filesystem tree
.IP \(bu 2
.B Tarball
.RI ( .tar ", " .tar.gz ", " .tar.bz2 ", " .tar.xz ", " .tar.zst )
\(em extract using native Rust crates with magic\-byte compression detection.
OCI container images are auto\-detected after extraction and their filesystem
layers are applied in order with whiteout handling.
.RE
.PP
Use
.B \-f
to remove a leftover staging directory from a previous failed import.
.SS sdme fs ls
List imported root filesystems with distro detection and paths.
.SS sdme fs rm \fIname\fR...
Remove one or more imported root filesystems.
.SS sdme fs build \fIname\fR \fIbuild.conf\fR [\-t \fIseconds\fR] [\-f]
Build a root filesystem from a build config file.
Creates a temporary staging container from the base rootfs specified by
.BR FROM ,
executes
.B RUN
and
.B COPY
directives sequentially, then captures the resulting merged
filesystem as a new rootfs named
.IR name .
.PP
Use
.B \-t
to override the boot timeout (default: 60 seconds or the
.B boot_timeout
config value).
Use
.B \-f
to replace an existing rootfs with the same name.
.PP
The staging container is automatically removed after the build completes
or on failure/Ctrl+C.
.PP
The build config is a line\-oriented text file with three directives:
.RS
.TP
.BI FROM " rootfs"
Base rootfs to build on (must be first directive, required, only once).
Must refer to a rootfs previously imported with
.BR "sdme fs import" .
.TP
.BI RUN " command"
Run a shell command inside the container via
.BR /bin/sh\ \-c .
Supports pipes, redirects, and compound commands.
The container is started automatically if not already running.
.TP
.BI COPY " src dst"
Copy a host file or directory into the rootfs.
The container is stopped before copying (overlayfs constraint).
If
.I dst
is an existing directory, the source is placed inside it.
Destination paths with
.B ..
components are rejected.
.RE
.PP
Lines starting with
.B #
and blank lines are ignored.
.SS sdme config get
Show current configuration values.
.SS sdme config set \fIkey\fR \fIvalue\fR
Set a configuration value.
Valid keys:
.RS
.TP
.B interactive
Enable or disable interactive mode.
Values:
.BR yes " or " no .
Default:
.BR yes .
.TP
.B datadir
Absolute path to the data directory.
Default:
.BR /var/lib/sdme .
.TP
.B boot_timeout
Boot timeout in seconds.
Values: positive integer.
Default:
.BR 60 .
.TP
.B join_as_sudo_user
Automatically join host\-rootfs containers as the
.B SUDO_USER
instead of root.
Values:
.BR yes " or " no .
Default:
.BR yes .
.RE
.SH CONFIGURATION
The configuration file is in TOML format, located at
.IR ~/.config/sdme/sdmerc .
When running under
.BR sudo (8),
the invoking user's config is preferred if it exists.
The path can also be set via the
.B \-c
option or the
.B XDG_CONFIG_HOME
environment variable.
.PP
Available keys:
.TP
.B interactive
Boolean.
Whether to run in interactive mode.
Default:
.BR true .
.TP
.B datadir
String.
Absolute path to the data directory.
Default:
.BR /var/lib/sdme .
.TP
.B boot_timeout
Integer.
Number of seconds to wait for a container to finish booting before giving up.
Can be overridden per\-command with
.BR \-t / \-\-timeout .
Default:
.BR 60 .
.TP
.B join_as_sudo_user
Boolean.
When true and the container uses the host root filesystem,
.B sdme join
and
.B sdme exec
pass
.BI \-\-uid " SUDO_USER"
to
.BR machinectl (1)
so the session runs as the invoking user rather than root.
Containers created with an imported rootfs are unaffected.
Default:
.BR true .
.SH FILES
.TP
.I /var/lib/sdme/
Default data directory (configurable via
.BR datadir ).
.TP
.I /var/lib/sdme/fs/\fIname\fR/
Imported root filesystems (lower layers).
.TP
.I /var/lib/sdme/state/\fIname\fR
Container state files (KEY=VALUE format).
Contains container metadata including creation timestamp, rootfs name,
resource limits
.RB ( MEMORY ", " CPUS ", " CPU_WEIGHT ),
and network configuration
.RB ( PRIVATE_NETWORK ", " NETWORK_VETH ", " NETWORK_BRIDGE ", " NETWORK_ZONE ", " PORTS ).
.TP
.I /var/lib/sdme/containers/\fIname\fR/upper/
Per\-container overlayfs upper layer (copy\-on\-write modifications).
.TP
.I /var/lib/sdme/containers/\fIname\fR/work/
Per\-container overlayfs work directory.
.TP
.I /var/lib/sdme/containers/\fIname\fR/merged/
Per\-container overlayfs merged mount point.
.TP
.I /var/lib/sdme/containers/\fIname\fR/shared/
Per\-container shared directory (accessible from host and container).
.TP
.I /etc/systemd/system/sdme@.service
Systemd template unit (auto\-installed and auto\-updated).
.TP
.I /etc/systemd/system/sdme@\fIname\fR.service.d/limits.conf
Per\-container resource limits drop\-in (created when limits are set,
removed when limits are cleared or the container is deleted).
.TP
.I ~/.config/sdme/sdmerc
User configuration file (TOML format).
.SH ENVIRONMENT
.TP
.B SUDO_USER
When set, sdme reads the invoking user's configuration file and resolves
their home directory for config file lookup.
.TP
.B XDG_CONFIG_HOME
Overrides the base directory for the configuration file.
Default:
.IR ~/.config .
.TP
.B HOME
Used to locate the configuration file when
.B XDG_CONFIG_HOME
is not set.
.TP
.BR https_proxy ", " HTTPS_PROXY ", " http_proxy ", " HTTP_PROXY ", " all_proxy ", " ALL_PROXY
Proxy URI for HTTP/HTTPS downloads during
.BR "sdme fs import" .
The first non\-empty variable found (in the order listed) is used.
Example:
.IR http://proxy:3128 .
Since
.B sdme
requires root, pass proxy variables through
.BR sudo (8)
with
.B \-E
or by setting them inline.
.TP
.BR no_proxy ", " NO_PROXY
Comma\-separated list of hosts or domains that should bypass the proxy.
.SH EXIT STATUS
.TP
.B 0
Success.
.TP
.B non\-zero
An error occurred.
Error messages are printed to standard error.
.SH EXAMPLES
Import an Ubuntu rootfs from a URL and create a container:
.PP
.RS
.nf
sdme fs import ubuntu https://example.com/ubuntu.tar.xz
sdme new mybox \-r ubuntu
.fi
.RE
.PP
Run a command in a running container:
.PP
.RS
.nf
sdme exec mybox cat /etc/os\-release
.fi
.RE
.PP
Create a container with resource limits:
.PP
.RS
.nf
sdme new \-\-memory 2G \-\-cpus 2 mybox \-r ubuntu
.fi
.RE
.PP
Update limits on an existing container:
.PP
.RS
.nf
sdme set mybox \-\-memory 4G
.fi
.RE
.PP
Follow logs for a container:
.PP
.RS
.nf
sdme logs mybox \-f
.fi
.RE
.PP
Import a rootfs through an HTTP proxy:
.PP
.RS
.nf
sudo \-E sdme fs import ubuntu https://example.com/ubuntu.tar.xz
.fi
.RE
.PP
Or pass the proxy variable inline:
.PP
.RS
.nf
sudo https_proxy=http://proxy:3128 sdme fs import ubuntu https://example.com/ubuntu.tar.xz
.fi
.RE
.PP
Create a container with a private network and port forwarding:
.PP
.RS
.nf
sdme new \-\-private\-network \-\-port 8080:80 webserver \-r ubuntu
.fi
.RE
.PP
Create containers in a shared network zone:
.PP
.RS
.nf
sdme new \-\-network\-zone myzone db \-r ubuntu
sdme new \-\-network\-zone myzone app \-r ubuntu
# app and db can now communicate over the shared zone network
.fi
.RE
.PP
Build a custom rootfs from an imported base:
.PP
.RS
.nf
# Import a base rootfs
debootstrap \-\-include=dbus,systemd noble /tmp/ubuntu
sdme fs import ubuntu /tmp/ubuntu

# Create a build config
cat << EOF > examplefs.conf
FROM ubuntu
RUN apt\-get update
RUN apt\-get install \-y systemd\-container
COPY ./target/release/sdme /usr/local/bin/sdme
EOF

# Build the new rootfs and create a container
sdme fs build examplefs examplefs.conf
sdme new \-r examplefs
.fi
.RE
.SH RESOURCE LIMITS
Containers can have per\-container resource limits applied via systemd cgroup
controls.
Limits are stored in the container's state file and applied at start time
through a systemd drop\-in file at
.IR /etc/systemd/system/sdme@ name .service.d/limits.conf .
.PP
If no limits are set, no drop\-in is written.
.TP
.BI \-\-memory " size"
Maximum memory the container may use.
Maps to the systemd
.B MemoryMax=
directive.
Accepts a number with an optional suffix:
.BR K ", " M ", " G ", " T .
Example:
.BR 512M ", " 2G .
.TP
.BI \-\-cpus " n"
CPU time limit expressed as a number of CPUs.
Converted to the systemd
.B CPUQuota=
directive (e.g.\&
.B 2
becomes
.BR 200% ).
Accepts integers or decimals.
Example:
.BR 2 ", " 0.5 .
.TP
.BI \-\-cpu\-weight " w"
Relative CPU scheduling weight.
Maps to the systemd
.B CPUWeight=
directive.
Range: 1\(en10000 (default kernel weight is 100).
Lower values get proportionally less CPU time under contention.
.SH NETWORKING
By default, containers share the host's network namespace and have full network
access.
Network options control network isolation and connectivity.
These options are set at container creation time and cannot be changed afterward.
.TP
.B \-\-private\-network
Run the container in its own private network namespace, isolated from the host.
Without additional options, the container will only have a loopback interface.
.TP
.B \-\-network\-veth
Create a virtual ethernet pair connecting the container to the host.
Implies
.BR \-\-private\-network .
The host side of the veth is named
.IR ve\-<name> .
Requires network configuration inside the container (DHCP or static IP) and
NAT/routing on the host for external connectivity.
.TP
.BI \-\-network\-bridge " name"
Connect the container's veth interface to the specified host bridge.
Implies
.BR \-\-private\-network .
The bridge must already exist on the host.
Example:
.BR br0 .
.TP
.BI \-\-network\-zone " name"
Join a named network zone for inter\-container networking.
Implies
.BR \-\-private\-network .
Containers in the same zone can communicate via a virtual bridge that
.BR systemd\-nspawn (1)
creates automatically.
Example:
.BR myzone .
.TP
.BI \-\-port ", " \-p " " host:container[/proto]
Forward a port from the host to the container.
Implies
.BR \-\-private\-network .
The protocol is
.B tcp
(default) or
.BR udp .
Can be specified multiple times for multiple ports.
Example:
.BR 8080:80 ,
.BR 53:53/udp .
.PP
Network configuration is stored in the container's state file and applied at
start time via environment variables in the systemd unit.
.SH NOTES
.SS Umask
.B sdme create
and
.B sdme new
require a umask that does not strip read or execute from "other".
If the current umask has bits
.B 005
set (e.g.\&
.BR 007 ", " 027 ", " 077 ),
creation is refused with a diagnostic message.
.PP
This is because files written to the overlayfs upper layer inherit the
process umask, and non\-root services inside the container (such as
.I dbus\-daemon
running as
.IR messagebus )
need to traverse the filesystem.
The default umask
.RB ( 022 )
is sufficient.
.SS Ctrl+C during boot
Pressing Ctrl+C while
.B sdme new
or
.B sdme start
is waiting for the container to boot will cancel the wait.
For
.BR "sdme new" ,
the just\-created container is removed automatically.
For
.BR "sdme start" ,
the container is stopped but preserved on disk.
.SH SECURITY
.B sdme
runs as root and processes untrusted input (tarballs, OCI images, disk images,
URLs).
The following hardening measures are in place:
.SS Path traversal protection
OCI layer tar paths are sanitized before whiteout marker handling:
entries containing
.B ..
components are rejected, and leading
.B /
is stripped.
OCI digest fields in manifests are validated to contain only alphanumeric
and hex characters before being used to resolve blob paths.
The
.B \-\-rootfs
parameter is validated against the same naming rules as container names,
preventing directory traversal via crafted values like
.IR ../state .
.SS Download size limit
URL downloads during
.B sdme fs import
are limited to 50\ GiB to prevent disk exhaustion from malicious or
misbehaving servers.
Downloads exceeding this limit are aborted with an error.
.SS File permissions
The configuration file is written with mode
.B 0600
and its parent directories with mode
.BR 0700 ,
regardless of the process umask.
State files are created atomically with
.BR O_CREAT|O_EXCL .
.SH SEE ALSO
.BR systemd\-nspawn (1),
.BR machinectl (1),
.BR journalctl (1),
.BR qemu\-nbd (8),
.BR overlayfs (5),
.BR sudo (8)
